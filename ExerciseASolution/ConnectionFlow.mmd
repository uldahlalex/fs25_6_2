sequenceDiagram
    participant Client
    participant WebSocketManager
    participant Redis
    participant Memory

    Note over Client,Memory: Connection Phase
    Client->>WebSocketManager: Connect
    WebSocketManager->>Memory: Add to _connections
    WebSocketManager->>WebSocketManager: Start 30s auth timer
    
    alt Authentication Success
        Client->>WebSocketManager: Authenticate(connectionId, userId)
        WebSocketManager->>Memory: Update _userToConnectionsMap
        WebSocketManager->>Redis: Store connection in Redis
        WebSocketManager->>Redis: Fetch previous topics
        loop For each previous topic
            WebSocketManager->>Redis: Resubscribe to topic
        end
        WebSocketManager->>Client: Return previous topics

    else Authentication Timeout
        WebSocketManager->>Client: Close connection
        WebSocketManager->>Memory: Remove from _connections
        WebSocketManager->>Redis: Cleanup connection data
    end

    Note over Client,Memory: Topic Interaction
    alt Subscribe to Topic
        Client->>WebSocketManager: Subscribe(connectionId, topicId)
        WebSocketManager->>Redis: Verify topic exists
        WebSocketManager->>Redis: Add to topic subscribers
        WebSocketManager->>Redis: Add to user topics
        WebSocketManager->>Client: Subscription success message
    end

    alt Send Message to Topic
        Client->>WebSocketManager: BroadcastToTopic(topicId, userId, payload)
        WebSocketManager->>Redis: Get topic subscribers
        par Broadcast to All Subscribers
            WebSocketManager->>Client: Send to subscriber 1
            WebSocketManager->>Client: Send to subscriber 2
            WebSocketManager->>Client: Send to subscriber N
        end
        WebSocketManager->>Redis: Store in message history
    end

    Note over Client,Memory: Disconnection
    Client->>WebSocketManager: Disconnect
    WebSocketManager->>Memory: Remove from _connections
    WebSocketManager->>Memory: Update _userToConnectionsMap
    WebSocketManager->>Redis: Remove connection data
    WebSocketManager->>Redis: Remove from topics